{% extends 'staff_user/base.html' %}
{% block content %}

  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">

  <div class="container py-4 bg-light">
    <div class="d-flex gap-2 mx-auto">
      <button id="clockInBtn" class="btn btn-success">Clock In</button>
      <h5 class="mx-auto">Attendance Calendar</h5>
      <button id="clockOutBtn" class="btn btn-danger">Clock Out</button>
      <p class="mt-2" id="logText"></p>
    </div>

    <div class="calendar-container">
        <h4 id="monthYear">Loading...</h4>
        <div class="calendar-grid" id="calendar"></div>
        <div class="calendar-header mt-4">
            <button id="prevMonthBtn" class="month-btn"></button>
            <button id="nextMonthBtn" class="month-btn"></button>
        </div>
    </div>
</div>

<script>
let currentMonth, currentYear, today, attendanceData = {};
const calendarEl = document.getElementById("calendar");
const monthYearText = document.getElementById("monthYear");
const prevBtn = document.getElementById("prevMonthBtn");
const nextBtn = document.getElementById("nextMonthBtn");

const monthNames = [
    "January", "February", "March", "April", "May", "June",
    "July", "August", "September", "October", "November", "December"
];

function fetchAndRenderCalendar(month, year) {
    fetch(`/overview/?month=${month + 1}&year=${year}`, {
        headers: { "X-Requested-With": "XMLHttpRequest" }
    })
    .then(res => res.json())
    .then(data => {
        attendanceData = data.attendance_data || {};
        renderCalendar(attendanceData, month, year);
    });
}

function renderCalendar(data, month, year) {
    calendarEl.innerHTML = "";

    const weekdays = ["Sun", "Mon", "Tue", "Wed", "Thu", "Fri", "Sat"];
    weekdays.forEach(day => {
        const div = document.createElement("div");
        div.className = "weekday";
        div.textContent = day;
        calendarEl.appendChild(div);
    });

    const firstDay = new Date(year, month, 1).getDay();
    const daysInMonth = new Date(year, month + 1, 0).getDate();

    for (let i = 0; i < firstDay; i++) {
        calendarEl.appendChild(document.createElement("div"));
    }

    for (let day = 1; day <= daysInMonth; day++) {
        const div = document.createElement("div");
        div.className = "day";
        const hours = data[day] ?? null;

        if (hours === 0) {
            div.classList.add("absent");
        } else if (hours >= 1 && hours < 4.5) {
            div.classList.add("incomplete");
        } else if (hours >= 4.5 && hours < 8) {
            div.classList.add("halfday");
        } else if (hours >= 8) {
            div.classList.add("present");
        }

        if (day === today.getDate() && month === today.getMonth() && year === today.getFullYear()) {
            div.classList.add("today");
        }

        div.innerHTML = `<strong>${day}</strong>`;
        calendarEl.appendChild(div);
    }

    monthYearText.textContent = `${monthNames[month]} ${year}`;

    const prevDate = new Date(year, month - 1);
    const nextDate = new Date(year, month + 1);
    prevBtn.textContent = `← ${monthNames[prevDate.getMonth()]}`;
    nextBtn.textContent = `${monthNames[nextDate.getMonth()]} →`;

    prevBtn.onclick = () => {
        if (month === 0) {
            currentMonth = 11;
            currentYear--;
        } else {
            currentMonth--;
        }
        fetchAndRenderCalendar(currentMonth, currentYear);
    };

    nextBtn.onclick = () => {
        if (month === 11) {
            currentMonth = 0;
            currentYear++;
        } else {
            currentMonth++;
        }
        fetchAndRenderCalendar(currentMonth, currentYear);
    };
}

function getISOTimeNow() {
    const now = new Date();
    const offset = now.getTimezoneOffset();
    const localTime = new Date(now.getTime() - offset * 60 * 1000);
    return localTime.toISOString().slice(0, 19);
}

function checkClockStatus() {
    const today = new Date();
    const todayStr = today.toISOString().slice(0, 10);
    const todayDay = today.getDate();

    fetch("{% url 'clock_status' %}?date=" + todayStr)
        .then(res => res.json())
        .then(data => {
            if (data.clock_in_done) {
                document.getElementById('clockInBtn').disabled = true;
                document.getElementById('clockInBtn').textContent = "Clocked In";
            }
            if (data.clock_out_done) {
                document.getElementById('clockOutBtn').disabled = true;
                document.getElementById('clockOutBtn').textContent = "Clocked Out";
            }
        });
}

document.addEventListener("DOMContentLoaded", () => {
    today = new Date();
    currentMonth = today.getMonth();
    currentYear = today.getFullYear();
    fetchAndRenderCalendar(currentMonth, currentYear);
    checkClockStatus();

    document.getElementById("clockInBtn").addEventListener("click", () => {
        fetch("{% url 'clock_in' %}", {
            method: 'POST',
            headers: { 'X-CSRFToken': '{{ csrf_token }}', 'Content-Type': 'application/json' },
            body: JSON.stringify({ clock_in_time: getISOTimeNow() })
        }).then(() => {
            document.getElementById("clockInBtn").disabled = true;
            document.getElementById("clockInBtn").textContent = "Clocked In";
            fetchAndRenderCalendar(currentMonth, currentYear);
        });
    });

    document.getElementById("clockOutBtn").addEventListener("click", () => {
        fetch("{% url 'clock_out' %}", {
            method: 'POST',
            headers: { 'X-CSRFToken': '{{ csrf_token }}', 'Content-Type': 'application/json' },
            body: JSON.stringify({ clock_out_time: getISOTimeNow() })
        })
        .then(res => res.json())
        .then(data => {
            document.getElementById("clockOutBtn").disabled = true;
            document.getElementById("clockOutBtn").textContent = "Clocked Out";
            const { hours_worked, date } = data;
            const calendarDays = document.querySelectorAll('#calendar .day');
            calendarDays.forEach(div => {
                const dayNum = parseInt(div.textContent.trim());
                if (dayNum === date) {
                    div.classList.remove("present", "absent", "incomplete", "halfday");
                    if (hours_worked === 0) div.classList.add("absent");
                    else if (hours_worked < 4.5) div.classList.add("incomplete");
                    else if (hours_worked < 8) div.classList.add("halfday");
                    else div.classList.add("present");
                }
            });
        });
    });
});
</script>

<style>
.calendar-container {
  max-width: 100%;
  margin: auto;
  padding: 10px;
}
.calendar-header {
  display: flex;
  justify-content: space-between;
  align-items: center;
  margin-bottom: 10px;
  flex-wrap: wrap;
}
.month-btn {
  background: #e0e0e0;
  border: none;
  padding: 6px 12px;
  border-radius: 5px;
  cursor: pointer;
  font-weight: 600;
}
#monthYear {
  font-size: 1.5rem;
  text-align: center;
  flex-grow: 1;
  margin: 5px;
}
.calendar-grid {
  display: grid;
  grid-template-columns: repeat(7, 1fr);
  gap: 6px;
}
.weekday {
  font-weight: bold;
  text-align: center;
  background: rgb(255, 241, 219);
  padding: 8px;
  border-radius: 4px;
}
.day {
  padding: 10px;
  text-align: center;
  border-radius: 4px;
  background: #f9f9f9;
  border: 1px solid #ddd;
}
.day.present {
  background-color: #4CAF50;
  color: white;
}
.day.halfday {
  background-color: #ffc107;
  color: black;
}
.day.incomplete {
  background-color: gray;
  color: white;
}
.day.absent {
  background-color: lightskyblue;
  color: black;
}
.today {
  font-size: 1.3rem;
  box-shadow: 0 2px 6px rgba(0, 0, 0, 0.2);
}
a, a:hover, a:focus, a:active, a:visited {
  text-decoration: none !important;
}
</style>

{% endblock %}
